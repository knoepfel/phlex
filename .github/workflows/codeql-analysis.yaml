# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "CodeQL Analysis"

on:
  push:
    branches: [ main, develop ]
  pull_request:
  schedule:
    - cron: '0 3 * * 0'  # weekly (UTC) â€” adjust as needed
  workflow_dispatch:
    inputs:
      ref:
        description: "The branch, ref, or SHA to checkout. Defaults to the repository's default branch."
        required: false
        type: string
  workflow_call:
    inputs:
      checkout-path:
        description: "Path to check out code to"
        required: false
        type: string
      build-path:
        description: "Path for build artifacts"
        required: false
        type: string
      language-matrix:
        description: "JSON array of languages to analyze"
        required: false
        type: string
      pr-number:
        description: "PR number if run in PR context"
        required: false
        type: string
      pr-head-repo:
        description: "The full name of the PR head repository"
        required: false
        type: string
      pr-base-repo:
        description: "The full name of the PR base repository"
        required: false
        type: string
      pr-base-sha:
        description: "Base SHA of the PR for relevance check"
        required: false
        type: string
      pr-head-sha:
        description: "Head SHA of the PR for relevance check"
        required: false
        type: string
      ref:
        description: "The branch, ref, or SHA to checkout"
        required: false
        type: string
      repo:
        description: "The repository to checkout from"
        required: false
        type: string

permissions:
  actions: read
  contents: read
  security-events: write

env:
  BUILD_TYPE: RelWithDebInfo
  CPP_COMPILER: g++

jobs:
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      is_act: ${{ steps.detect_act.outputs.is_act }}
      ref: ${{ (github.event_name == 'workflow_call' && inputs.ref) || (github.event_name == 'workflow_dispatch' && (github.event.inputs.ref || github.ref)) || github.sha }}
      repo: ${{ (github.event_name == 'workflow_call' && inputs.repo) || github.repository }}
      base_sha: ${{ (github.event_name == 'workflow_call' && inputs.pr-base-sha) || github.event.pull_request.base.sha || github.event.before }}
      skip_detection: ${{ steps.should_skip.outputs.skip }}
      local_checkout_path: ${{ (github.event_name == 'workflow_call' && inputs.checkout-path) || format('{0}-src', github.event.repository.name) }}
    steps:
      - name: Detect act environment
        id: detect_act
        uses: Framework-R-D/phlex/.github/actions/detect-act-env@main

      - name: Determine if detection should be skipped
        id: should_skip
        run: |
          # Skip detection for scheduled runs, workflow_dispatch, or workflow_call with language-matrix override
          if [ "${{ github.event_name }}" = "schedule" ] || \
             [ "${{ github.event_name }}" = "workflow_dispatch" ] || \
             [ "${{ github.event_name }}" = "push" ] || \
             { [ "${{ github.event_name }}" = "workflow_call" ] && [ -n "${{ inputs.language-matrix }}" ]; } || \
             [ "${{ steps.detect_act.outputs.is_act }}" = "true" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

  detect-changes-cpp:
    needs: pre-check
    if: >
      needs.pre-check.result == 'success' &&
      needs.pre-check.outputs.skip_detection != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_changes: ${{ steps.filter.outputs.matched }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          path: ${{ needs.pre-check.outputs.local_checkout_path }}
          ref: ${{ needs.pre-check.outputs.ref }}
          repository: ${{ needs.pre-check.outputs.repo }}

      - name: Detect C++ relevant changes
        id: filter
        uses: Framework-R-D/phlex/.github/actions/detect-relevant-changes@main
        with:
          repo-path: ${{ needs.pre-check.outputs.local_checkout_path }}
          base-ref: ${{ needs.pre-check.outputs.base_sha }}
          head-ref: ${{ (github.event_name == 'workflow_call' && inputs.pr-head-sha) || needs.pre-check.outputs.ref }}
          file-type: |
            cpp
            cmake

      - name: Report detection outcome
        run: |
          if [ "${{ steps.filter.outputs.matched }}" != "true" ]; then
            echo "::notice::No C++ relevant changes detected; C++ CodeQL scan will be skipped."
          else
            echo "::group::C++ CodeQL relevant files"
            printf '%s\n' "${{ steps.filter.outputs.matched_files }}"
            echo "::endgroup::"
          fi

  detect-changes-python:
    needs: pre-check
    if: >
      needs.pre-check.result == 'success' &&
      needs.pre-check.outputs.skip_detection != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_changes: ${{ steps.filter.outputs.matched }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          path: ${{ needs.pre-check.outputs.local_checkout_path }}
          ref: ${{ needs.pre-check.outputs.ref }}
          repository: ${{ needs.pre-check.outputs.repo }}

      - name: Detect Python relevant changes
        id: filter
        uses: Framework-R-D/phlex/.github/actions/detect-relevant-changes@main
        with:
          repo-path: ${{ needs.pre-check.outputs.local_checkout_path }}
          base-ref: ${{ needs.pre-check.outputs.base_sha }}
          head-ref: ${{ (github.event_name == 'workflow_call' && inputs.pr-head-sha) || needs.pre-check.outputs.ref }}
          file-type: python

      - name: Report detection outcome
        run: |
          if [ "${{ steps.filter.outputs.matched }}" != "true" ]; then
            echo "::notice::No Python relevant changes detected; Python CodeQL scan will be skipped."
          else
            echo "::group::Python CodeQL relevant files"
            printf '%s\n' "${{ steps.filter.outputs.matched_files }}"
            echo "::endgroup::"
          fi

  detect-changes-actions:
    needs: pre-check
    if: >
      needs.pre-check.result == 'success' &&
      needs.pre-check.outputs.skip_detection != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_changes: ${{ steps.filter.outputs.matched }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          path: ${{ needs.pre-check.outputs.local_checkout_path }}
          ref: ${{ needs.pre-check.outputs.ref }}
          repository: ${{ needs.pre-check.outputs.repo }}

      - name: Detect Actions/workflow relevant changes
        id: filter
        uses: Framework-R-D/phlex/.github/actions/detect-relevant-changes@main
        with:
          repo-path: ${{ needs.pre-check.outputs.local_checkout_path }}
          base-ref: ${{ needs.pre-check.outputs.base_sha }}
          head-ref: ${{ (github.event_name == 'workflow_call' && inputs.pr-head-sha) || needs.pre-check.outputs.ref }}
          include-globs: |
            .github/workflows/*.yaml
            .github/workflows/*.yml
            .github/actions/**/action.yaml
            .github/actions/**/action.yml

      - name: Report detection outcome
        run: |
          if [ "${{ steps.filter.outputs.matched }}" != "true" ]; then
            echo "::notice::No Actions/workflow relevant changes detected; Actions CodeQL scan will be skipped."
          else
            echo "::group::Actions CodeQL relevant files"
            printf '%s\n' "${{ steps.filter.outputs.matched_files }}"
            echo "::endgroup::"
          fi

  determine-languages:
    needs: [pre-check, detect-changes-cpp, detect-changes-python, detect-changes-actions]
    if: always() && needs.pre-check.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      languages: ${{ steps.build_matrix.outputs.languages }}
    steps:
      - name: Build language matrix
        id: build_matrix
        env:
          LANGUAGE_MATRIX: ${{ inputs.language-matrix }}
        run: |
          # If detection was skipped, use all languages or the provided language-matrix
          if [ "${{ needs.pre-check.outputs.skip_detection }}" = "true" ]; then
            if [ "${{ github.event_name }}" = "workflow_call" ] && [ -n "$LANGUAGE_MATRIX" ]; then
              # Validate that language-matrix is valid JSON
              if ! echo "$LANGUAGE_MATRIX" | python3 -c "import sys, json; json.load(sys.stdin)" 2>/dev/null; then
                echo "::error::Invalid language-matrix input: must be valid JSON array"
                exit 1
              fi
              echo "languages=$LANGUAGE_MATRIX" >> "$GITHUB_OUTPUT"
            else
              echo 'languages=["cpp", "python", "actions"]' >> "$GITHUB_OUTPUT"
            fi
            exit 0
          fi

          # Build array based on detection results
          langs=()
          if [ "${{ needs.detect-changes-cpp.result }}" = "success" ] && [ "${{ needs.detect-changes-cpp.outputs.has_changes }}" = "true" ]; then
            langs+=("cpp")
          fi
          if [ "${{ needs.detect-changes-python.result }}" = "success" ] && [ "${{ needs.detect-changes-python.outputs.has_changes }}" = "true" ]; then
            langs+=("python")
          fi
          if [ "${{ needs.detect-changes-actions.result }}" = "success" ] && [ "${{ needs.detect-changes-actions.outputs.has_changes }}" = "true" ]; then
            langs+=("actions")
          fi

          # Convert bash array to JSON array
          if [ "${#langs[@]}" -eq 0 ]; then
            echo 'languages=[]' >> "$GITHUB_OUTPUT"
          else
            json_array="["
            for i in "${!langs[@]}"; do
              if [ "$i" -gt 0 ]; then
                json_array+=","
              fi
              json_array+="\"${langs[$i]}\""
            done
            json_array+="]"
            echo "languages=$json_array" >> "$GITHUB_OUTPUT"
          fi

  codeql:
    needs: [pre-check, determine-languages]
    if: >
      needs.determine-languages.result == 'success' &&
      needs.determine-languages.outputs.languages != '[]'
    name: Analyze ${{ matrix.language }} with CodeQL
    runs-on: ubuntu-24.04
    container:
      image: ghcr.io/framework-r-d/phlex-ci:latest
    env:
      local_checkout_path: ${{ needs.pre-check.outputs.local_checkout_path }}
      local_build_path: ${{ (github.event_name == 'workflow_call' && inputs.build-path) || format('{0}-build', github.event.repository.name) }}
      CODEQL_EXTRACTOR_CPP_COMPILATION_DATABASE: ${{ github.workspace }}/${{ (github.event_name == 'workflow_call' && inputs.build-path) || format('{0}-build', github.event.repository.name) }}/compile_commands.json
    strategy:
      fail-fast: false
      matrix:
        language: ${{ fromJson(needs.determine-languages.outputs.languages) }}
    timeout-minutes: 120
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ needs.pre-check.outputs.ref }}
          path: ${{ env.local_checkout_path }}
          fetch-depth: 0

      - name: Setup build environment
        uses: Framework-R-D/phlex/.github/actions/setup-build-env@main
        with:
          build-path: ${{ env.local_build_path }}

      - name: Initialize CodeQL
        uses: github/codeql-action/init@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
        with:
          languages: ${{ matrix.language }}
          config-file: ${{ env.local_checkout_path }}/.github/codeql/codeql-config.yml
          source-root: ${{ env.local_checkout_path }}
          build-mode: none

      - name: Produce compile_commands.json (C++ only)
        if: matrix.language == 'cpp'
        uses: Framework-R-D/phlex/.github/actions/configure-cmake@main
        with:
          build-type: ${{ env.BUILD_TYPE }}
          source-path: ${{ env.local_checkout_path }}
          build-path: ${{ env.local_build_path }}

      - name: Verify compile_commands.json (C++ only)
        if: matrix.language == 'cpp'
        run: |
          set -eu
          if [ ! -f "$CODEQL_EXTRACTOR_CPP_COMPILATION_DATABASE" ]; then
            echo "Expected compile_commands.json at $CODEQL_EXTRACTOR_CPP_COMPILATION_DATABASE" >&2
            exit 1
          fi

      # Run CodeQL analysis (uploads results to code scanning)
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@89a39a4e59826350b863aa6b6252a07ad50cf83e # v4.32.4
        with:
          checkout_path: ${{ env.local_checkout_path }}
          output: results
          category: ${{ matrix.language }}

      - name: Upload SARIF results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: codeql-sarif-${{ matrix.language }}
          path: results
          retention-days: 7

  codeql-report:
    name: Aggregate CodeQL alerts
    needs: codeql
    runs-on: ubuntu-24.04
    if: needs.codeql.result == 'success'
    permissions:
      contents: read
      issues: write
      pull-requests: write
      security-events: read
    env:
      CODEQL_MIN_LEVEL: warning
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Set log file path
        id: set_log_path
        run: echo "path=$RUNNER_TEMP/codeql-alerts.log" >> "$GITHUB_OUTPUT"
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Checkout Phlex for scripts
        if: github.event_name == 'workflow_call'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: Framework-R-D/phlex
          path: phlex
          fetch-depth: 0

      - name: Download CodeQL SARIF artifacts
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          pattern: codeql-sarif-*
          path: sarif
          merge-multiple: true

      - name: Check CodeQL SARIF for new or resolved alerts
        id: check_codeql
        run: |
          set -eu
          ARGS=(
            --sarif "$GITHUB_WORKSPACE/sarif"
            --min-level "${CODEQL_MIN_LEVEL}"
            --log-path "${{ steps.set_log_path.outputs.path }}"
          )
          PR_NUMBER=""
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          elif [ "${{ github.event_name }}" = "workflow_call" ]; then
            PR_NUMBER="${{ inputs.pr-number }}"
          fi

          if [ -n "$PR_NUMBER" ]; then
            ARGS+=(--ref "refs/pull/${PR_NUMBER}/merge")
          fi

          script_path="scripts/check_codeql_alerts.py"
          if [ "${{ github.event_name }}" = "workflow_call" ]; then
            script_path="phlex/$script_path"
          fi
          python3 "$script_path" "${ARGS[@]}"

      - name: Upload CodeQL alerts debug log
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: codeql-alerts-debug-log
          path: ${{ steps.set_log_path.outputs.path }}
          retention-days: 3

      - name: Prepare PR comment data
        if: >-
          github.event_name == 'pull_request' &&
          steps.check_codeql.outputs.comment_path != ''
        run: |
          mkdir -p pr_comment_data
          echo "${{ github.event.pull_request.number }}" > pr_comment_data/pr_number.txt
          cp "${{ steps.check_codeql.outputs.comment_path }}" pr_comment_data/comment_body.md

      - name: Upload PR comment data
        if: >-
          github.event_name == 'pull_request' &&
          steps.check_codeql.outputs.comment_path != ''
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: codeql-pr-data
          path: pr_comment_data/
          retention-days: 1

      - name: Fail workflow due to new CodeQL alerts
        # Fails the check on the PR so the user sees red X
        if: >-
          github.event_name == 'pull_request' &&
          steps.check_codeql.outputs.new_alerts == 'true'
        run: |
          echo "New CodeQL alerts detected; failing job."
          exit 1
